<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=375, user-scalable=no, target-densitydpi=device-dpi">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title></title>
	<style type="text/css">
		html,body{padding: 0;margin: 0;height: 100%;}
		.container{height: 100%;display: flex;flex-direction: column;}
		#main{background-color: #f0f0f0;}
		#myimg{width: 100%;}
		.btn-box{text-align: center;}
		.btn-box .btn{background-color:#5E98F3;color: #fff;padding: 10px;}
		.canvas-box{flex: 1;display: flex;justify-content: center;align-items: center;}
	</style>
</head>
<body>
	<div class="container">
		<div class="btn-box">
			<div class="btn" onclick="createPoster()">预览</div>
		</div>
		<div class="canvas-box">
			<canvas id="main" width='355' height='473'></canvas>
		</div>
		<div class="btn-box">
			<label>
				<div class="btn">加图</div>
				<input type="file" id="upimg" name="file" accept="image/png,image/jpg,image/jpeg" id="file" onchange="changeToop();" style="display:none;" />
			</label>
		</div>
	</div> 
	<img src="" id="myimg">
</body>
<script src="js/fabric.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/customiseControls.min.js" type="text/javascript" charset="utf-8"></script>
<script>
	var cWidth = document.getElementById('main').clientWidth
	var cHeight = document.getElementById('main').clientHeight
	fabric.Object.prototype.set({
		padding:5
	})
	var canvas = new fabric.Canvas('main');
	fabric.Canvas.prototype.customiseControls({
	    tl: {
	        action: 'remove',
			cursor:'pointer'
	    },
	    tr: {
			action: function (e, target) {
	            target.clone(function (cloneObj) {
	               cloneObj.set({
	                 left: cloneObj.left + 20,
	                 top: cloneObj.top + 20
	               })
	               cloneObj.setCoords()
	               canvas.add(cloneObj)
	               canvas.renderAll()
	            })
	        },
			cursor:'pointer'
	    }
	},function(){
	    canvas.renderAll();
	});
	fabric.Object.prototype.customiseCornerIcons({
	    settings: {
	        borderColor: '#DB639B',
	        cornerSize: 20,
	        cornerShape: 'rect',
	        cornerBackgroundColor: 'transparent',
	        cornerPadding: 0,
	    },
	    tl: {
	        icon: 'img/colse.svg'
	    },
		tr:{
			icon:'img/plus1.svg'
		},
		br:{
			icon:'img/fangda.svg'
		},
		mtr:{
			icon:'img/zhuan.svg'
		}
	},function(){
	    canvas.renderAll();
	});
	function changeToop(){
		let url = window.URL.createObjectURL(document.getElementById('upimg').files.item(0));
		addImg(url)
	}
	function addImg(src,opstion){
		let data = opstion?opstion:'';
		let img = new Image()
		img.src = src
		img.onload = function(){
			if(!data){
				data = {}
				data.left = (cWidth/2)-(img.width/2)
				data.top = (cHeight/2)-(img.height/2)
			}
			fabric.Image.fromURL(src, function(res) {
				canvas.add(res);
			},data);
		}
	}
	function createPoster(){
		let src = canvas.toDataURL({
			format:'png',
			quality:1,
			left:0,
			top:0,
			width:cWidth,
			height:cHeight
		});
		document.getElementById("myimg").src = src
	}
</script>
</html>