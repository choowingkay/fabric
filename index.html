<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=375, user-scalable=no, target-densitydpi=device-dpi">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title></title>
	<style type="text/css">
		html,body{padding: 0;margin: 0;height: 100%;background-color: #333;}
		.container{height: 100%;display: flex;flex-direction: column;}
		#main{background-color: #f0f0f0;}
		.btn-box{display: flex;align-items: center;justify-content: center;}
		.btn-box .btn{color: #fff;padding: 10px;}
		.canvas-box{flex: 1;display: flex;justify-content: center;align-items: center;}
	</style>
</head>
<body>
	<div class="container">
		<div class="btn-box">
			<div class="btn" onclick="prveStep()">上一步</div>
			<div class="btn" onclick="nextStep()">下一步</div>
			<div class="btn" onclick="createPoster()">预览</div>
		</div>
		<div class="canvas-box">
			<canvas id="main" width='355' height='473'></canvas>
		</div>
		<div class="btn-box">
			<div class="btn" onclick="addText('添加文字',kayCanvasData.length)">加字</div>
			<label>
				<div class="btn">加图</div>
				<input type="file" id="upimg" name="file" accept="image/png,image/jpg,image/jpeg" id="file" onchange="changeToop();" style="display:none;" />
			</label>
		</div>
	</div>
</body>
<script src="js/fabric.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/customiseControls.min.js" type="text/javascript" charset="utf-8"></script>
<script>
	var storageCanvasData = [];
	var canvasIdx = 0;
	var kayCanvasData = []
	storageCanvasData.push(kayCanvasData)
	var cWidth = document.getElementById('main').clientWidth
	var cHeight = document.getElementById('main').clientHeight
	fabric.Object.prototype.set({
		padding:5
	})
	var canvas = new fabric.Canvas('main');
	fabric.Canvas.prototype.customiseControls({
	    tl: {
	        action: 'remove',
			cursor:'pointer'
	    },
	    tr: {
			action: function (e, target) {
	            target.clone(function (cloneObj) {
					cloneObj.set({
						left: cloneObj.left + 20,
						top: cloneObj.top + 20
					})
					cloneObj.setCoords()
					canvas.add(cloneObj)
					canvas.renderAll()
					let arr = JSON.parse(JSON.stringify(kayCanvasData))
					arr.push({
					   	type:cloneObj.type,
					   	cont:cloneObj.type=='text'?cloneObj.text:cloneObj.src,
					   	opstion:{
					   		left:cloneObj.left,
					   		top:cloneObj.top,
					   		originX:cloneObj.originX||'center',
					   		originY:cloneObj.originY||'center',
					   		scaleX:cloneObj.scaleX||1,
					   		scaleY:cloneObj.scaleY||1,
					   		angle:cloneObj.angle||0
					   	}
					 })
					kayCanvasData = arr
					storageCanvasData.push(arr)
					canvasIdx = storageCanvasData.length-1
	            })
	        },
			cursor:'pointer'
	    }
	},function(){
	    canvas.renderAll();
	});
	fabric.Object.prototype.customiseCornerIcons({
	    settings: {
	        borderColor: '#DB639B',
	        cornerSize: 20,
	        cornerShape: 'rect',
	        cornerBackgroundColor: 'transparent',
	        cornerPadding: 0,
	    },
	    tl: {
	        icon: 'img/colse.svg'
	    },
		tr:{
			icon:'img/plus1.svg'
		},
		br:{
			icon:'img/fangda.svg'
		},
		mtr:{
			icon:'img/zhuan.svg'
		}
	},function(){
	    canvas.renderAll();
	});
	function changeToop(){
		var url = window.URL.createObjectURL(document.getElementById('upimg').files.item(0));
		addImg(url,this.kayCanvasData.length)
	}
	// 加入图片src:图片路径、opstion配置
	function addImg(src,idx,opstion,type){
		var data = opstion?opstion:'';
		if(!data){
			data = {}
			data.left = (cWidth/2)
			data.top = (cHeight/2)
			data.originX = 'center'
			data.originY = 'center'
		}
		fabric.Image.fromURL(src, function(res) {
			if(!type){
				res.on('added',function(){
					let arr = JSON.parse(JSON.stringify(kayCanvasData))
					arr.push({
						type:'image',
						cont:src,
						opstion:{
							left:this.left,
							top:this.top,
							originX:this.originX||'center',
							originY:this.originY||'center',
							scaleX:this.scaleX||1,
							scaleY:this.scaleY||1,
							angle:this.angle||0
						}
					})
					kayCanvasData = arr
					storageCanvasData.push(arr)
					canvasIdx = storageCanvasData.length-1
				})
			}
			res.on('modified',function(){
				let arr = JSON.parse(JSON.stringify(kayCanvasData))
				arr[idx].cont = this.src
				arr[idx].opstion = {
					left:this.left,
					top:this.top,
					originX:this.originX||'center',
					originY:this.originY||'center',
					scaleX:this.scaleX||1,
					scaleY:this.scaleY||1,
					angle:this.angle||0
				}
				kayCanvasData = arr
				storageCanvasData.push(arr)
				canvasIdx = storageCanvasData.length-1
			})
			canvas.add(res);
		},data);
	}
	// 加入文本:字符串、opstion配置
	function addText(string,idx,opstion,type){
		var data = opstion?opstion:'';
		if(!data){
			data = {}
			data.left = (cWidth/2)
			data.top = (cHeight/2)
			data.originX = 'center'
			data.originY = 'center'
		}
		var res = new fabric.IText(string,data);
		if(!type){
			res.on('added',function(){
				let arr = JSON.parse(JSON.stringify(kayCanvasData))
				arr.push({
					type:'text',
					cont:this.text,
					opstion:{
						left:this.left,
						top:this.top,
						originX:this.originX||'center',
						originY:this.originY||'center',
						scaleX:this.scaleX||1,
						scaleY:this.scaleY||1,
						angle:this.angle||0
					}
				})
				kayCanvasData = arr
				storageCanvasData.push(arr)
				canvasIdx = storageCanvasData.length-1
			})
		}
		res.on('modified',function(){
			console.log(this)
			let arr = JSON.parse(JSON.stringify(kayCanvasData))
			arr[idx].cont = this.text
			arr[idx].opstion = {
				left:this.left,
				top:this.top,
				originX:this.originX||'center',
				originY:this.originY||'center',
				scaleX:this.scaleX||1,
				scaleY:this.scaleY||1,
				angle:this.angle||0
			}
			kayCanvasData = arr
			storageCanvasData.push(arr)
			canvasIdx = storageCanvasData.length-1
		})
		canvas.add(res);
	}
	// 上一步
	function prveStep(){
		if(canvasIdx>0){
			canvasIdx--
			canvasRestrt(storageCanvasData[canvasIdx])
		}
		console.log(canvasIdx)
	}
	// 下一步
	function nextStep(){
		if(canvasIdx<storageCanvasData.length-1){
			canvasIdx++
			canvasRestrt(storageCanvasData[canvasIdx])
		}
		console.log(canvasIdx)
	}
	function canvasRestrt(data){
		canvas.clear()
		for (var i = 0; i < data.length; i++) {
			if(data[i].type=='image'){
				addImg(data[i].cont,i,data[i].opstion,'xr')
			}else{
				addText(data[i].cont,i,data[i].opstion,'xr')
			}
		}
	}
	// 生成海报预览
	function createPoster(){
		var src = canvas.toDataURL({
			format:'png',
			quality:1,
			left:0,
			top:0,
			width:cWidth,
			height:cHeight
		});
		localStorage.setItem("kayimgsrc", src);
		window.location.href = 'img.html'
	}
</script>
</html>